<?php

/**
 * Implements hook_permission().
 */
function cfas_permission() {
  return array(
    'configure_cfas' => array(
      'title' => t('Configure CFAS Module'),
      'description' => t('Allows users to configure the CFAS module.'),
      'restrict access' => TRUE,
    ),
  );
}

/**
 * Implements hook_menu().
 */
function cfas_menu() {
  $items = array();

  $items['admin/config/media/cfas'] = array(
    'title' => 'CKEditor Flickr Album Slideshow',
    'description' => 'Configuration for the CFAS module',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('cfas_admin_form'),
    'access arguments' => array('configure_cfas'),
    'type' => MENU_NORMAL_ITEM,
  );

  $items['cfas-album'] = array(
    'page callback' => 'cfas_album_submit',
    'type' => MENU_CALLBACK,
    'access callback' => TRUE
  );

  return $items;
}

/**
 * Form for admin settings()
 */
function cfas_admin_form($form, &$form_state) {
  $form['cfas_flickr_api_key'] = array(
    '#type' => 'textfield',
    '#title' => t('Flickr API Key'),
    '#default_value' => variable_get('cfas_flickr_api_key'),
  );

  return system_settings_form($form);
}

/**
 * Implements hook_wysiwyg_plugin().
 */
function cfas_theme($existing, $type, $theme, $path) {
  return array(
    'cfas_slideshow' => array(
      'vars' => array(
        'images' => null
      ),
      'template' => 'templates/cfas-slideshow'
    ),
    'cfas_missing_api_key' => array(
      'vars' => array(),
      'template' => 'templates/cfas-missing-api-key'
    ),
    'cfas_invalid_response' => array(
      'vars' => array(
        'message' => null
      ),
      'template' => 'templates/cfas-invalid-response'
    )
  );
}

/**
 * Implements hook_wysiwyg_plugin().
 */
function cfas_wysiwyg_plugin($editor, $version) {
  $plugins = array();
  if ($editor == 'ckeditor' && version_compare($version, '4.0', '>=')) {
    $plugins['flickrAlbumSlideshow'] = array(
      'path' => drupal_get_path('module', 'cfas') . '/plugins/flickrAlbumSlideshow',
      'buttons' => array(
        'flickrAlbumSlideshow' => t('Flickr album slideshow'),
      ),
      'load' => TRUE,
      'internal' => FALSE,
    );
  }
  return $plugins;
}

/**
 * Implements hook_wysiwyg_editor_settings_alter().
 */
function cfas_wysiwyg_editor_settings_alter(&$settings, $context) {
  if ($context['profile']->editor == 'ckeditor') {
    $settings['allowedContent'] = TRUE;
  }
}

/**
 * Implements hook_filter_info().
 */
function cfas_filter_info() {
  $filters['cfas'] = array(
    'title' => t('Embed Flickr album slideshow'),
    'description' => t('By including a div with a data-flickr-album attribute, this filter will embed the a Flickr album slideshow'),
    'process callback' => 'cfas_filter_process',
    'tips callback'  => 'cfas_filter_tips',
    'cache' => FALSE,
  );

  return $filters;
}

function cfas_filter_process($text, $filter) {
  return preg_replace_callback('/<div.*data-flickr-album="([^"]+)">[&nbsp;]*<\/div>/U', 'cfas_filter_process_callback', $text);
}

function cfas_filter_tips($filter, $format, $long = FALSE) {
  return t('Insert a Flickr album slideshow.');
}

function cfas_filter_process_callback($matches) {
  // Flexslider deps
  drupal_add_css(libraries_get_path('flexslider') . '/flexslider.css');
  drupal_add_js(libraries_get_path('flexslider') . '/jquery.flexslider-min.js');
  // CFAS deps
  drupal_add_js(drupal_get_path('module', 'cfas') . '/js/cfas--flexslider.js');
  drupal_add_css(drupal_get_path('module', 'cfas') . '/css/cfas.css');

  return cfas_get_album($matches[1]);
}

function cfas_get_album($album_url) {
  module_load_include('php', 'cfas', 'includes/FlickrAlbum');

  $api_key = variable_get('cfas_flickr_api_key', false);

  // Bail and display error message of no API key has been set.
  if (!$api_key) {
    return theme('cfas_missing_api_key',
      array(
        'url' => $GLOBALS['base_path'] . '/admin/config/media/cfas'
      )
    );
  }
  $flickr = new FlickrAlbum($api_key, $album_url);
  $album = $flickr->getAlbum();

  // If no valid album, fetch using Flickr API and store record
  if (empty($album)) {
    $album = $flickr->fetchAlbum();
  }

  // Handle photoset not found
  if (
    isset($album['stat']) &&
    $album['stat'] === 'fail'
  ) {
    return theme('cfas_invalid_response',
      array(
        'message' => $album['message']
      )
    );
  }

  // Either way, we now have an album. Now theme the images.
  return theme('cfas_slideshow',
    array(
      'images' => unserialize($album['images'])
    )
  );
}

/**
 * Accept album id from POST data and return images
 */
function cfas_album_submit() {
  // Block non-authenticated users
  if (user_is_anonymous()) {
    print json_encode(array('error' => 'CFAS: Authentication required'));
    drupal_exit();
  }

  // Grab raw POST data
  $json = file_get_contents('php://input');
  $decoded = json_decode($json, true);
  $output = cfas_get_album($decoded['album_url']);
  print $output;
  drupal_exit();
}

/**
 * Implements hook_element_info_alter().
 */
function cfas_element_info_alter(&$types) {
  $types['text_format']['#pre_render'][] = 'cfas_pre_render_text_format';
}

function cfas_pre_render_text_format($element) {
  // Flexslider deps
  $element['#attached']['js'][] = libraries_get_path('flexslider') . '/jquery.flexslider-min.js';
  // CFAS deps
  $element['#attached']['js'][] = drupal_get_path('module', 'cfas') . '/js/cfas--flexslider.js';
  $element['#attached']['js'][] = drupal_get_path('module', 'cfas') . '/js/cfas--drupal.js';
  $element['#attached']['js'][] = drupal_get_path('module', 'cfas') . '/js/cfas--form-submit.js';

  return $element;
}

/**
 * Implements template_preprocess_page()
 */
function cfas_preprocess_page(&$vars) {
  drupal_add_js(array('cfas' => array(
    'flexsliderCss' => libraries_get_path('flexslider') . '/flexslider.css',
  )), 'setting');
}